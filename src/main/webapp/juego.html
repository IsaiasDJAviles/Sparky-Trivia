<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="sparky_logo.png">
    <title>Jugando - Sparky Trivia</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">

    <style>
        body {
            overflow-x: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .game-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        /* COUNTDOWN INICIAL */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .countdown-numero {
            font-size: 12rem;
            font-weight: 900;
            color: white;
            animation: countdownPulse 1s ease;
            text-shadow: 0 0 50px rgba(255,255,255,0.5);
        }

        .countdown-texto {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.8);
            margin-top: 20px;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* AREA PRINCIPAL - PREGUNTA */
        .pregunta-area {
            flex: 1;
            max-width: 800px;
        }

        .pregunta-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .timer-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .timer-progress {
            height: 100%;
            transition: width 1s linear;
            border-radius: 10px;
        }

        .timer-progress.paused {
            transition: none;
        }

        .pregunta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pregunta-numero {
            font-size: 1rem;
            font-weight: 600;
            color: #5e72e4;
        }

        .pregunta-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
            font-weight: 700;
            color: #32325d;
        }

        .pregunta-timer.warning {
            color: #f5365c;
            animation: pulse 0.5s infinite;
        }

        .pregunta-timer.paused {
            color: #2dce89;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pregunta-puntos {
            background: linear-gradient(135deg, #f5365c, #f56036);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
        }

        .pregunta-contenido {
            font-size: 1.6rem;
            font-weight: 700;
            color: #32325d;
            margin-bottom: 30px;
            line-height: 1.4;
            min-height: 60px;
        }

        .pregunta-imagen {
            max-height: 250px;
            margin-bottom: 25px;
            text-align: center;
        }

        .pregunta-imagen img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* OPCIONES DE RESPUESTA */
        .opciones-container {
            display: grid;
            gap: 12px;
        }

        .opcion-btn {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 18px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.05rem;
        }

        .opcion-btn:hover:not(:disabled) {
            border-color: #5e72e4;
            transform: translateX(8px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .opcion-letra {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5e72e4, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .opcion-texto {
            flex: 1;
            font-weight: 500;
        }

        .opcion-btn.seleccionada {
            border-color: #5e72e4;
            background: rgba(94, 114, 228, 0.1);
        }

        .opcion-btn.enviando {
            border-color: #ffd600;
            background: rgba(255, 214, 0, 0.1);
        }

        .opcion-btn.confirmada {
            border-color: #2dce89;
            background: rgba(45, 206, 137, 0.1);
        }

        .opcion-btn.correcta {
            border-color: #2dce89;
            background: rgba(45, 206, 137, 0.15);
            animation: correctaPulse 0.5s ease;
        }

        .opcion-btn.correcta .opcion-letra {
            background: linear-gradient(135deg, #2dce89, #11cdef);
        }

        .opcion-btn.incorrecta {
            border-color: #f5365c;
            background: rgba(245, 54, 92, 0.1);
            animation: shake 0.5s ease;
        }

        .opcion-btn.incorrecta .opcion-letra {
            background: linear-gradient(135deg, #f5365c, #f56036);
        }

        .opcion-btn:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        @keyframes correctaPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ESTADO DE RESPUESTA */
        .estado-respuesta {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }

        .estado-respuesta.enviando {
            display: block;
            background: rgba(255, 214, 0, 0.2);
            color: #856404;
        }

        .estado-respuesta.confirmada {
            display: block;
            background: rgba(45, 206, 137, 0.2);
            color: #155724;
        }

        /* EXPLICACION */
        .explicacion-card {
            background: rgba(255, 255, 255, 0.95);
            border-left: 4px solid #ffd600;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        /* SIDEBAR - RANKING EN VIVO */
        .ranking-sidebar {
            width: 320px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .ranking-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .ranking-header h4 {
            margin: 0;
            font-weight: 700;
            color: #5e72e4;
            font-size: 1.1rem;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.5s ease;
        }

        .ranking-item.moving {
            animation: moveUp 0.5s ease;
        }

        @keyframes moveUp {
            0% { transform: translateY(20px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .ranking-item.top-1 {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .ranking-item.top-2 {
            border-color: #C0C0C0;
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));
        }

        .ranking-item.top-3 {
            border-color: #CD7F32;
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));
        }

        .ranking-pos {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5e72e4, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .ranking-item.top-1 .ranking-pos {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .ranking-item.top-2 .ranking-pos {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
        }

        .ranking-item.top-3 .ranking-pos {
            background: linear-gradient(135deg, #CD7F32, #B8860B);
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-nick {
            font-weight: 700;
            color: #32325d;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-stats {
            font-size: 0.8rem;
            color: #8898aa;
        }

        .ranking-pts {
            font-weight: 700;
            font-size: 1.1rem;
            color: #5e72e4;
        }

        /* ESTADO DE CONEXION */
        .conexion-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-online {
            background: linear-gradient(135deg, #2dce89, #11cdef);
            color: white;
        }

        .status-offline {
            background: linear-gradient(135deg, #f5365c, #f56036);
            color: white;
        }

        /* RESPONSIVE */
        @media (max-width: 992px) {
            .game-container {
                flex-direction: column;
            }

            .ranking-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                order: -1;
            }

            .countdown-numero {
                font-size: 8rem;
            }
        }

        @media (max-width: 576px) {
            .pregunta-contenido {
                font-size: 1.3rem;
            }

            .opcion-btn {
                padding: 14px;
            }

            .opcion-letra {
                width: 38px;
                height: 38px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>

<div id="particles-js"></div>

<!-- COUNTDOWN INICIAL -->
<div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-numero" id="countdownNumero">3</div>
    <div class="countdown-texto">Preparate...</div>
</div>

<!-- ESTADO DE CONEXION -->
<div id="conexionStatus" class="conexion-status status-offline">
    <i class="bi bi-wifi-off"></i>
    <span>Conectando...</span>
</div>

<!-- CONTENEDOR PRINCIPAL -->
<div class="game-container" id="gameContainer" style="display: none;">
    <!-- AREA DE PREGUNTA -->
    <div class="pregunta-area">
        <!-- Barra de tiempo -->
        <div class="timer-bar">
            <div class="timer-progress" id="timerProgress" style="width: 100%; background: linear-gradient(90deg, #2dce89, #11cdef);"></div>
        </div>

        <!-- Card de pregunta -->
        <div class="pregunta-card">
            <div class="pregunta-header">
                <div class="pregunta-numero" id="numeroPregunta">Pregunta 1 de ?</div>
                <div class="pregunta-timer" id="timerText">
                    <i class="bi bi-clock"></i>
                    <span id="timerSeconds">30</span>s
                </div>
                <div class="pregunta-puntos">
                    <i class="bi bi-star-fill me-1"></i><span id="puntosPreg">100</span> pts
                </div>
            </div>

            <div class="pregunta-contenido" id="contenidoPregunta">Esperando pregunta...</div>

            <div class="pregunta-imagen d-none" id="imagenPregunta"></div>

            <div class="opciones-container" id="opcionesContainer">
                <!-- Las opciones se cargan dinamicamente -->
            </div>

            <!-- Estado de respuesta -->
            <div class="estado-respuesta" id="estadoRespuesta">
                <i class="bi bi-hourglass-split me-2"></i>
                <span id="estadoTexto">Enviando respuesta...</span>
            </div>

            <!-- Explicacion -->
            <div class="explicacion-card d-none" id="explicacionCard">
                <h6><i class="bi bi-lightbulb-fill text-warning me-2"></i>Explicacion</h6>
                <p id="explicacionTexto" class="mb-0"></p>
            </div>
        </div>
    </div>

    <!-- SIDEBAR - RANKING EN VIVO -->
    <div class="ranking-sidebar">
        <div class="ranking-card">
            <div class="ranking-header">
                <i class="bi bi-trophy-fill" style="font-size: 1.3rem; color: #FFD700;"></i>
                <h4>Ranking en Vivo</h4>
            </div>

            <div id="rankingLive">
                <div class="text-center text-muted py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <p class="mb-0 mt-2" style="font-size: 0.9rem;">Esperando inicio...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="js/auth.js"></script>

<script>
    // =============================================
    // VARIABLES GLOBALES
    // =============================================
    let websocket = null;
    let codigoSala = null;
    let usuario = null;
    let participanteId = null;

    // Estado del juego
    let preguntaActual = null;
    let tiempoInicio = null;
    let timerInterval = null;
    let tiempoRestante = 0;

    // Flags de control
    let puedeResponder = false;
    let yaRespondio = false;
    let respuestaConfirmada = false;
    let opcionSeleccionadaId = null;

    // Ranking
    let rankingActual = [];
    let totalPreguntasTrivia = 0;

    // =============================================
    // INICIALIZACION
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
        protegerPagina('login.html');
        usuario = obtenerUsuario();

        const params = new URLSearchParams(window.location.search);
        codigoSala = params.get('codigo');
        participanteId = parseInt(params.get('participante')) || null;

        if (!codigoSala) {
            alert('Codigo de sala no especificado');
            window.location.href = 'dashboard.html';
            return;
        }

        console.log('=== INICIANDO JUEGO ===');
        console.log('Sala:', codigoSala);
        console.log('Usuario:', usuario.nickName);
        console.log('Participante ID:', participanteId);

        // Inicializar particles
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 40 },
                    color: { value: '#ffffff' },
                    opacity: { value: 0.2 },
                    size: { value: 3 },
                    move: { enable: true, speed: 1 }
                }
            });
        }

        // Conectar WebSocket primero
        conectarWebSocket();

        // Iniciar countdown (sincronizado con el backend que espera 5 segundos)
        iniciarCountdown();
    });

    // =============================================
    // COUNTDOWN INICIAL
    // =============================================
    function iniciarCountdown() {
        let contador = 3;
        const countdownNumero = document.getElementById('countdownNumero');
        const countdownTexto = document.querySelector('.countdown-texto');

        const interval = setInterval(() => {
            contador--;

            if (contador > 0) {
                countdownNumero.textContent = contador;
                countdownNumero.style.animation = 'none';
                setTimeout(() => {
                    countdownNumero.style.animation = 'countdownPulse 1s ease';
                }, 10);
            } else if (contador === 0) {
                countdownNumero.textContent = 'GO!';
                countdownNumero.style.color = '#2dce89';
                countdownTexto.textContent = 'Comienza el juego!';
            } else {
                // Ocultar overlay y mostrar juego
                document.getElementById('countdownOverlay').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'flex';

                // Cargar ranking inicial
                inicializarRankingInicial();

                clearInterval(interval);
            }
        }, 1000);
    }

    // =============================================
    // WEBSOCKET
    // =============================================
    function conectarWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}/SparkyTrivia/game/${codigoSala}`;

        console.log('Conectando WebSocket:', wsUrl);

        websocket = new WebSocket(wsUrl);

        websocket.onopen = function() {
            console.log('WebSocket conectado');
            actualizarEstadoConexion(true);

            // Notificar al servidor que estamos listos
            enviarMensaje({
                tipo: 'UNIRSE',
                usuarioId: usuario.usuarioId,
                nickname: usuario.nickName,
                participanteId: participanteId
            });
        };

        websocket.onmessage = function(event) {
            try {
                const mensaje = JSON.parse(event.data);
                console.log('Mensaje recibido:', mensaje.tipo);

                manejarMensaje(mensaje);
            } catch (error) {
                console.error('Error parseando mensaje:', error);
            }
        };

        websocket.onerror = function(error) {
            console.error('Error WebSocket:', error);
            actualizarEstadoConexion(false);
        };

        websocket.onclose = function(event) {
            console.log('WebSocket cerrado:', event.code);
            actualizarEstadoConexion(false);

            // Reconectar si fue cierre inesperado
            if (event.code !== 1000) {
                setTimeout(conectarWebSocket, 3000);
            }
        };
    }

    function manejarMensaje(mensaje) {
        switch(mensaje.tipo) {
            case 'PREGUNTA':
                manejarNuevaPregunta(mensaje);
                break;
            case 'RESPUESTA_CONFIRMADA':
                manejarConfirmacionRespuesta(mensaje);
                break;
            case 'RESPUESTA_CORRECTA':
                manejarRespuestaCorrecta(mensaje);
                break;
            case 'RANKING':
                actualizarRanking(mensaje.ranking);
                break;
            case 'JUEGO_FINALIZADO':
                manejarFinJuego(mensaje);
                break;
            default:
                console.log('Mensaje no manejado:', mensaje.tipo);
        }
    }

    // =============================================
    // MANEJO DE PREGUNTAS
    // =============================================
    function manejarNuevaPregunta(mensaje) {
        console.log('=== NUEVA PREGUNTA ===');
        console.log('Numero:', mensaje.numeroPregunta, 'de', mensaje.totalPreguntas);

        // Resetear estado
        preguntaActual = mensaje.pregunta;
        puedeResponder = true;
        yaRespondio = false;
        respuestaConfirmada = false;
        opcionSeleccionadaId = null;
        tiempoInicio = Date.now();

        // Guardar total de preguntas
        totalPreguntasTrivia = mensaje.totalPreguntas;

        // Ocultar explicacion anterior
        document.getElementById('explicacionCard').classList.add('d-none');
        document.getElementById('estadoRespuesta').className = 'estado-respuesta';

        // Actualizar numero de pregunta
        document.getElementById('numeroPregunta').textContent =
            `Pregunta ${mensaje.numeroPregunta} de ${mensaje.totalPreguntas}`;

        // Actualizar contenido
        document.getElementById('contenidoPregunta').textContent = preguntaActual.contenido;
        document.getElementById('puntosPreg').textContent = preguntaActual.puntos || 100;

        // Imagen
        const imgContainer = document.getElementById('imagenPregunta');
        if (preguntaActual.imagen) {
            imgContainer.innerHTML = `<img src="${preguntaActual.imagen}" alt="Imagen">`;
            imgContainer.classList.remove('d-none');
        } else {
            imgContainer.classList.add('d-none');
        }

        // Renderizar opciones
        renderizarOpciones();

        // Iniciar temporizador
        iniciarTemporizador(preguntaActual.limiteTiempo || 30);
    }

    function renderizarOpciones() {
        const container = document.getElementById('opcionesContainer');
        container.innerHTML = '';

        const letras = ['A', 'B', 'C', 'D', 'E', 'F'];

        preguntaActual.opciones.forEach((opcion, index) => {
            const btn = document.createElement('button');
            btn.className = 'opcion-btn';
            btn.dataset.opcionId = opcion.opcionId;
            btn.innerHTML = `
                <div class="opcion-letra">${letras[index]}</div>
                <div class="opcion-texto">${opcion.textoOpcion}</div>
            `;
            btn.onclick = () => seleccionarOpcion(opcion.opcionId, btn);
            container.appendChild(btn);
        });
    }

    // =============================================
    // TEMPORIZADOR - SE PAUSA AL RESPONDER
    // =============================================
    function iniciarTemporizador(segundos) {
        clearInterval(timerInterval);

        tiempoRestante = segundos;
        const tiempoTotal = segundos;
        const timerProgress = document.getElementById('timerProgress');
        const timerText = document.getElementById('timerText');
        const timerSeconds = document.getElementById('timerSeconds');

        // Resetear estilos
        timerProgress.classList.remove('paused');
        timerText.classList.remove('warning', 'paused');
        timerProgress.style.width = '100%';
        timerProgress.style.background = 'linear-gradient(90deg, #2dce89, #11cdef)';

        timerInterval = setInterval(() => {
            // NO decrementar si ya respondio
            if (yaRespondio) {
                return;
            }

            tiempoRestante--;
            timerSeconds.textContent = tiempoRestante;

            // Actualizar barra de progreso
            const porcentaje = (tiempoRestante / tiempoTotal) * 100;
            timerProgress.style.width = porcentaje + '%';

            // Cambiar color segun tiempo
            if (tiempoRestante <= 5) {
                timerProgress.style.background = 'linear-gradient(90deg, #f5365c, #f56036)';
                timerText.classList.add('warning');
            } else if (tiempoRestante <= 10) {
                timerProgress.style.background = 'linear-gradient(90deg, #fb6340, #ffd600)';
                timerText.classList.remove('warning');
            }

            // Tiempo agotado
            if (tiempoRestante <= 0) {
                clearInterval(timerInterval);
                puedeResponder = false;

                // Deshabilitar opciones
                document.querySelectorAll('.opcion-btn').forEach(btn => {
                    btn.disabled = true;
                });
            }
        }, 1000);
    }

    function pausarTemporizador() {
        const timerProgress = document.getElementById('timerProgress');
        const timerText = document.getElementById('timerText');

        timerProgress.classList.add('paused');
        timerText.classList.remove('warning');
        timerText.classList.add('paused');
    }

    // =============================================
    // SELECCION DE RESPUESTA
    // =============================================
    function seleccionarOpcion(opcionId, btnElement) {
        if (!puedeResponder || yaRespondio) {
            console.log('No puede responder:', { puedeResponder, yaRespondio });
            return;
        }

        // Marcar que ya respondio
        yaRespondio = true;
        puedeResponder = false;
        opcionSeleccionadaId = opcionId;

        // PAUSAR EL TIMER
        pausarTemporizador();

        // Calcular tiempo tomado
        const tiempoTomado = Math.floor((Date.now() - tiempoInicio) / 1000);

        console.log('Respuesta seleccionada:', opcionId);
        console.log('Tiempo tomado:', tiempoTomado, 'segundos');

        // Deshabilitar todas las opciones
        document.querySelectorAll('.opcion-btn').forEach(btn => {
            btn.disabled = true;
        });

        // Marcar opcion seleccionada
        btnElement.classList.add('seleccionada', 'enviando');

        // Mostrar estado de envio
        const estadoDiv = document.getElementById('estadoRespuesta');
        estadoDiv.className = 'estado-respuesta enviando';
        document.getElementById('estadoTexto').textContent = 'Enviando respuesta...';

        // Enviar respuesta al servidor
        enviarRespuesta(opcionId, tiempoTomado);
    }

    function enviarRespuesta(opcionId, tiempoTomado) {
        enviarMensaje({
            tipo: 'RESPUESTA',
            participanteId: participanteId,
            preguntaId: preguntaActual.preguntaId,
            opcionId: opcionId,
            tiempoTomado: tiempoTomado
        });
    }

    // =============================================
    // CONFIRMACION DE RESPUESTA
    // =============================================
    function manejarConfirmacionRespuesta(mensaje) {
        // Verificar que sea para este participante
        if (mensaje.participanteId !== participanteId) return;

        console.log('Respuesta confirmada por el servidor');
        respuestaConfirmada = true;

        // Actualizar UI
        const btnSeleccionado = document.querySelector('.opcion-btn.seleccionada');
        if (btnSeleccionado) {
            btnSeleccionado.classList.remove('enviando');
            btnSeleccionado.classList.add('confirmada');
        }

        const estadoDiv = document.getElementById('estadoRespuesta');
        estadoDiv.className = 'estado-respuesta confirmada';
        document.getElementById('estadoTexto').textContent = 'Respuesta registrada - Esperando resultado...';
    }

    // =============================================
    // RESPUESTA CORRECTA
    // =============================================
    function manejarRespuestaCorrecta(mensaje) {
        console.log('Respuesta correcta:', mensaje.opcionCorrectaId);

        clearInterval(timerInterval);

        // Ocultar estado de respuesta
        document.getElementById('estadoRespuesta').className = 'estado-respuesta';

        // Marcar opciones
        document.querySelectorAll('.opcion-btn').forEach(btn => {
            const btnOpcionId = parseInt(btn.dataset.opcionId);

            if (btnOpcionId === mensaje.opcionCorrectaId) {
                btn.classList.remove('seleccionada', 'enviando', 'confirmada');
                btn.classList.add('correcta');
            } else if (btnOpcionId === opcionSeleccionadaId && btnOpcionId !== mensaje.opcionCorrectaId) {
                btn.classList.remove('seleccionada', 'enviando', 'confirmada');
                btn.classList.add('incorrecta');
            }
        });

        // Mostrar explicacion
        if (mensaje.explicacion) {
            document.getElementById('explicacionTexto').textContent = mensaje.explicacion;
            document.getElementById('explicacionCard').classList.remove('d-none');
        }
    }

    // =============================================
    // RANKING EN TIEMPO REAL
    // =============================================
    async function inicializarRankingInicial() {
        try {
            const response = await fetch(`/SparkyTrivia/api/salas/detalle?codigo=${codigoSala}`, {
                method: 'GET',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.sala && data.sala.participantes) {
                const rankingInicial = data.sala.participantes.map((p, index) => ({
                    posicion: index + 1,
                    nickname: p.nickname,
                    puntaje: 0,
                    correctas: 0,
                    respondidas: 0
                }));

                actualizarRanking(rankingInicial);
            }
        } catch (error) {
            console.error('Error cargando ranking inicial:', error);
        }
    }

    function actualizarRanking(ranking) {
        const container = document.getElementById('rankingLive');

        if (!ranking || ranking.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-hourglass-split"></i>
                    <p class="mb-0 mt-2">Esperando jugadores...</p>
                </div>
            `;
            return;
        }

        // Ordenar por puntaje descendente
        const rankingOrdenado = [...ranking].sort((a, b) => b.puntaje - a.puntaje);

        // Detectar cambios de posicion
        const posicionesAnteriores = new Map();
        rankingActual.forEach((j, idx) => {
            posicionesAnteriores.set(j.nickname, idx);
        });

        rankingActual = rankingOrdenado;

        // Renderizar
        container.innerHTML = rankingOrdenado.map((jugador, index) => {
            let claseTop = '';
            if (index === 0) claseTop = 'top-1';
            else if (index === 1) claseTop = 'top-2';
            else if (index === 2) claseTop = 'top-3';

            const posAnterior = posicionesAnteriores.get(jugador.nickname);
            const cambio = posAnterior !== undefined && posAnterior !== index;

            return `
                <div class="ranking-item ${claseTop} ${cambio ? 'moving' : ''}">
                    <div class="ranking-pos">${index + 1}</div>
                    <div class="ranking-info">
                        <div class="ranking-nick">${jugador.nickname}</div>
                        <div class="ranking-stats">${jugador.correctas || 0}/${jugador.respondidas || 0} correctas</div>
                    </div>
                    <div class="ranking-pts">${jugador.puntaje || 0}</div>
                </div>
            `;
        }).join('');

        // Quitar animacion despues
        setTimeout(() => {
            document.querySelectorAll('.ranking-item.moving').forEach(item => {
                item.classList.remove('moving');
            });
        }, 500);
    }

    // =============================================
    // FIN DEL JUEGO
    // =============================================
    function manejarFinJuego(mensaje) {
        console.log('=== JUEGO FINALIZADO ===');
        clearInterval(timerInterval);

        // Guardar ranking en localStorage
        if (mensaje.rankingFinal) {
            localStorage.setItem('rankingFinal_' + codigoSala, JSON.stringify(mensaje.rankingFinal));
        }

        // Mostrar mensaje
        document.getElementById('contenidoPregunta').innerHTML = `
            <div class="text-center">
                <h2 class="text-success mb-3">Juego Terminado!</h2>
                <p>Redirigiendo a resultados...</p>
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        `;
        document.getElementById('opcionesContainer').innerHTML = '';

        // Redirigir a resultados
        setTimeout(() => {
            window.location.href = `resultados.html?codigo=${codigoSala}`;
        }, 3000);
    }

    // =============================================
    // UTILIDADES
    // =============================================
    function enviarMensaje(mensaje) {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify(mensaje));
        } else {
            console.error('WebSocket no conectado');
        }
    }

    function actualizarEstadoConexion(conectado) {
        const status = document.getElementById('conexionStatus');
        if (conectado) {
            status.className = 'conexion-status status-online';
            status.innerHTML = '<i class="bi bi-wifi"></i> <span>Conectado</span>';
        } else {
            status.className = 'conexion-status status-offline';
            status.innerHTML = '<i class="bi bi-wifi-off"></i> <span>Desconectado</span>';
        }
    }

    // Limpiar al salir
    window.addEventListener('beforeunload', function() {
        if (websocket) websocket.close();
        clearInterval(timerInterval);
    });
</script>
</body>
</html>