<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Sparky Trivia</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">

    <style>
        .lobby-container {
            min-height: 100vh;
            padding: 40px 20px;
        }

        .codigo-sala {
            background: linear-gradient(135deg, var(--color-azul-claro), var(--color-morado));
            color: white;
            padding: 30px;
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 30px;
        }

        .codigo-sala h1 {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 15px;
            margin: 10px 0;
        }

        .trivia-info {
            background: rgba(255, 255, 255, 0.85);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 30px;
        }

        .jugadores-container {
            background: rgba(255, 255, 255, 0.85);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 30px;
        }

        .jugador-item {
            background: white;
            padding: 15px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid #e9ecef;
            animation: fadeInUp 0.3s ease;
        }

        .jugador-item.host {
            border-color: var(--color-amarillo);
            background: linear-gradient(135deg, rgba(255, 214, 0, 0.1), rgba(255, 214, 0, 0.05));
        }

        .jugador-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-azul-claro), var(--color-morado));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .jugador-info {
            flex: 1;
        }

        .jugador-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-host {
            background: var(--gradient-warning);
            color: white;
        }

        .contador-jugadores {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-azul-claro);
            text-align: center;
            margin-bottom: 20px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .conexion-status {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .status-conectado {
            background: var(--gradient-success);
            color: white;
        }

        .status-desconectado {
            background: var(--gradient-danger);
            color: white;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
<div id="particles-js"></div>

<!-- Status de Conexi√≥n WebSocket -->
<div class="conexion-status status-desconectado" id="conexionStatus">
    <i class="bi bi-wifi-off"></i>
    <span>Conectando...</span>
</div>

<header class="header">
    <div class="header-content">
        <div class="logo">
            <img src="images/sparky_logo.png" alt="Sparky">
            <h1>Sparky Trivia</h1>
        </div>
    </div>
</header>

<div class="lobby-container">
    <div class="container" style="max-width: 900px;">

        <!-- C√≥digo de Sala -->
        <div class="codigo-sala">
            <p class="mb-2">C√≥digo de Sala</p>
            <h1 id="codigoSala">------</h1>
            <button class="btn btn-amarillo btn-ripple mt-3" onclick="copiarCodigo()">
                <i class="bi bi-clipboard me-2"></i>Copiar C√≥digo
            </button>
        </div>

        <!-- Info de la Trivia -->
        <div class="trivia-info">
            <h3><i class="bi bi-collection-fill me-2"></i>Trivia</h3>
            <h4 id="tituloTrivia">Cargando...</h4>
            <p class="text-muted mb-2">
                <i class="bi bi-bookmark-fill me-2"></i><span id="categoriaTrivia">-</span> |
                <i class="bi bi-speedometer2 me-2"></i><span id="dificultadTrivia">-</span> |
                <i class="bi bi-question-circle me-2"></i><span id="preguntasTrivia">-</span> preguntas
            </p>
        </div>

        <!-- Jugadores -->
        <div class="jugadores-container">
            <div class="contador-jugadores">
                <i class="bi bi-people-fill me-2"></i>
                <span id="contadorJugadores">0/50</span> Jugadores
            </div>

            <div id="listaJugadores">
                <!-- Jugadores se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="row g-3">
            <div class="col-md-6">
                <button class="btn btn-rojo btn-ripple" style="width: 100%;" onclick="abandonarSala()">
                    <i class="bi bi-box-arrow-left me-2"></i>Salir de la Sala
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-verde btn-ripple" style="width: 100%;" id="btnIniciar" onclick="iniciarPartida()" disabled>
                    <i class="bi bi-play-circle-fill me-2"></i>Iniciar Partida
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="js/animations.js"></script>
<script src="js/auth.js"></script>

<script>
    let websocket = null;
    let codigoSala = null;
    let usuario = null;
    let esHost = false;
    let pollingInterval = null;
    let miParticipanteId = null;
    let salaId = null;

    document.addEventListener('DOMContentLoaded', function() {
        protegerPagina('login.html');
        usuario = obtenerUsuario();

        // Obtener c√≥digo de sala de la URL
        const params = new URLSearchParams(window.location.search);
        codigoSala = params.get('codigo');

        if (!codigoSala) {
            alert('C√≥digo de sala no especificado');
            window.location.href = 'dashboard.html';
            return;
        }

        document.getElementById('codigoSala').textContent = codigoSala;

        // Cargar datos de la sala
        cargarDatosSala();

        // Conectar WebSocket
        conectarWebSocket();

        // Polling de respaldo (cada 3 segundos)
        pollingInterval = setInterval(cargarDatosSala, 3000);
    });

    async function cargarDatosSala() {
        try {
            const response = await fetch(`/SparkyTrivia/api/salas/detalle?codigo=${codigoSala}`, {
                method: 'GET',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.sala) {
                const sala = data.sala;

                // GUARDAR SALA ID Y PARTICIPANTE ID
                salaId = sala.salaId;

                // Actualizar info de trivia
                document.getElementById('tituloTrivia').textContent = sala.trivia.titulo;
                document.getElementById('categoriaTrivia').textContent = sala.trivia.categoria;
                document.getElementById('dificultadTrivia').textContent = sala.trivia.dificultad;
                document.getElementById('preguntasTrivia').textContent = sala.trivia.preguntasTotales;

                // Actualizar contador
                document.getElementById('contadorJugadores').textContent =
                    `${sala.usuariosActuales}/${sala.maxUsuarios}`;

                // Verificar si soy el host
                esHost = (sala.host.usuarioId === usuario.usuarioId);
                document.getElementById('btnIniciar').disabled = !esHost;

                // Buscar MI participanteId
                const miParticipacion = sala.participantes.find(p =>
                    p.nickname === usuario.nickName
                );
                if (miParticipacion) {
                    miParticipanteId = miParticipacion.participanteId;
                }

                // Actualizar lista de jugadores
                actualizarListaJugadores(sala.participantes);
            }
        } catch (error) {
            console.error('Error cargando datos de sala:', error);
        }
    }

    function actualizarListaJugadores(participantes) {
        const lista = document.getElementById('listaJugadores');

        lista.innerHTML = participantes.map(p => `
            <div class="jugador-item ${p.esHost ? 'host' : ''}">
                <div class="jugador-avatar">
                    ${p.nickname.charAt(0).toUpperCase()}
                </div>
                <div class="jugador-info">
                    <strong>${escaparHTML(p.nickname)}</strong>
                    ${p.esHost ? '<span class="jugador-badge badge-host ms-2">HOST</span>' : ''}
                </div>
                ${p.esActivo ? '<i class="bi bi-circle-fill text-success"></i>' : ''}
            </div>
        `).join('');
    }

    function conectarWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}/SparkyTrivia/game/${codigoSala}`;

        console.log('Conectando WebSocket a:', wsUrl);

        try {
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function() {
                console.log('‚úÖ WebSocket conectado');
                actualizarStatus(true);

                // Notificar que me un√≠
                websocket.send(JSON.stringify({
                    tipo: 'UNIRSE',
                    usuarioId: usuario.usuarioId,
                    nickname: usuario.nickName
                }));
            };

            websocket.onmessage = function(event) {
                console.log('üì© Mensaje recibido:', event.data);
                const mensaje = JSON.parse(event.data);

                switch(mensaje.tipo) {
                    case 'CONECTADO':
                        console.log('Confirmaci√≥n de conexi√≥n recibida');
                        break;

                    case 'JUGADOR_UNIDO':
                        console.log(`üë§ ${mensaje.nickname} se uni√≥`);
                        cargarDatosSala(); // Actualizar lista
                        break;

                    case 'JUGADOR_SALIO':
                        console.log('üëã Un jugador sali√≥');
                        cargarDatosSala();
                        break;

                    case 'PARTIDA_INICIADA':
                        console.log('üöÄ Partida iniciada!');

                        // Redirigir a pantalla de juego
                        setTimeout(() => {
                            window.location.href = `juego.html?codigo=${codigoSala}&participante=${miParticipanteId}`;
                        }, 500);
                        break;
                }
            };

            websocket.onerror = function(error) {
                console.error('‚ùå Error WebSocket:', error);
                actualizarStatus(false);
            };

            websocket.onclose = function() {
                console.log('üî¥ WebSocket desconectado');
                actualizarStatus(false);

                // Intentar reconectar despu√©s de 3 segundos
                setTimeout(() => {
                    if (codigoSala) {
                        console.log('üîÑ Intentando reconectar...');
                        conectarWebSocket();
                    }
                }, 3000);
            };

        } catch (error) {
            console.error('‚ùå Error creando WebSocket:', error);
            actualizarStatus(false);
        }
    }

    function actualizarStatus(conectado) {
        const status = document.getElementById('conexionStatus');

        if (conectado) {
            status.className = 'conexion-status status-conectado';
            status.innerHTML = '<i class="bi bi-wifi pulse"></i><span>Conectado</span>';
        } else {
            status.className = 'conexion-status status-desconectado';
            status.innerHTML = '<i class="bi bi-wifi-off"></i><span>Desconectado</span>';
        }
    }

    async function iniciarPartida() {
        if (!esHost) {
            alert('Solo el host puede iniciar la partida');
            return;
        }

        if (!salaId) {
            alert('Error: No se pudo obtener el ID de la sala');
            return;
        }

        try {
            const response = await postRequest('/SparkyTrivia/api/salas/iniciar', {
                salaId: salaId
            });

            if (response.success) {
                console.log('‚úÖ Partida iniciada en el servidor');

                // Iniciar el GameManager en el servidor
                await fetch('/SparkyTrivia/api/salas/iniciar-juego', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ codigoSala: codigoSala })
                });

                // El WebSocket notificar√° con PARTIDA_INICIADA a todos
                // Lo cual redirigir√° autom√°ticamente a juego.html

            } else {
                alert(response.message || 'Error al iniciar partida');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexi√≥n al iniciar partida');
        }
    }

    function abandonarSala() {
        if (confirm('¬øSeguro que quieres salir de la sala?')) {
            if (websocket) {
                websocket.close();
            }
            clearInterval(pollingInterval);
            window.location.href = 'dashboard.html';
        }
    }

    function copiarCodigo() {
        navigator.clipboard.writeText(codigoSala);
        alert('¬°C√≥digo copiado!');
    }

    function escaparHTML(texto) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return texto.replace(/[&<>"']/g, m => map[m]);
    }

    // Limpiar al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        if (websocket) {
            websocket.close();
        }
        clearInterval(pollingInterval);
    });
</script>
</body>
</html>