<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="sparky_logo.png">
    <title>Resultados - Sparky Trivia</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">

    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .resultados-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .resultado-titulo {
            text-align: center;
            color: white;
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .resultado-subtitulo {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 1.2rem;
            margin-bottom: 40px;
        }

        /* PODIO */
        .podio-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .podio {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            min-height: 350px;
        }

        .podio-item {
            text-align: center;
            transition: transform 0.3s ease;
        }

        .podio-item:hover {
            transform: translateY(-10px);
        }

        .podio-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            color: white;
            position: relative;
        }

        .primero .podio-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        .primero .podio-avatar::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
        }

        .segundo .podio-avatar {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            box-shadow: 0 10px 30px rgba(192, 192, 192, 0.4);
        }

        .tercero .podio-avatar {
            background: linear-gradient(135deg, #CD7F32, #B8860B);
            box-shadow: 0 10px 30px rgba(205, 127, 50, 0.4);
        }

        .podio-nombre {
            font-weight: 700;
            font-size: 1.2rem;
            color: #32325d;
            margin-bottom: 10px;
        }

        .podio-stats {
            background: #f7f8fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .podio-puntaje {
            font-size: 2rem;
            font-weight: 800;
            color: #5e72e4;
        }

        .podio-correctas {
            color: #2dce89;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .podio-base {
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
        }

        .primero .podio-base {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            height: 120px;
            width: 140px;
        }

        .segundo .podio-base {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            height: 90px;
            width: 120px;
        }

        .tercero .podio-base {
            background: linear-gradient(135deg, #CD7F32, #B8860B);
            height: 60px;
            width: 120px;
        }

        /* RANKING COMPLETO */
        .ranking-completo {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .ranking-completo h3 {
            color: #5e72e4;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .ranking-tabla-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .ranking-tabla-item:hover {
            border-color: #5e72e4;
            transform: translateX(5px);
        }

        .ranking-tabla-item.yo {
            border-color: #5e72e4;
            background: linear-gradient(135deg, rgba(94, 114, 228, 0.1), rgba(94, 114, 228, 0.05));
        }

        .ranking-tabla-pos {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5e72e4, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .ranking-tabla-info {
            flex: 1;
        }

        .ranking-tabla-nombre {
            font-weight: 700;
            color: #32325d;
            margin-bottom: 3px;
        }

        .ranking-tabla-stats {
            font-size: 0.85rem;
            color: #8898aa;
        }

        .ranking-tabla-pts {
            font-weight: 800;
            font-size: 1.3rem;
            color: #5e72e4;
        }

        /* MIS RESPUESTAS */
        .mis-respuestas {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .mis-respuestas h3 {
            color: #5e72e4;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .respuesta-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .respuesta-item.correcta {
            border-left-color: #2dce89;
        }

        .respuesta-item.incorrecta {
            border-left-color: #f5365c;
        }

        .respuesta-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .respuesta-icono {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .respuesta-item.correcta .respuesta-icono {
            background: linear-gradient(135deg, #2dce89, #11cdef);
            color: white;
        }

        .respuesta-item.incorrecta .respuesta-icono {
            background: linear-gradient(135deg, #f5365c, #f56036);
            color: white;
        }

        .respuesta-pregunta {
            flex: 1;
            font-weight: 600;
            color: #32325d;
        }

        .respuesta-puntos {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .respuesta-item.correcta .respuesta-puntos {
            color: #2dce89;
        }

        .respuesta-item.incorrecta .respuesta-puntos {
            color: #f5365c;
        }

        .respuesta-detalles {
            padding-left: 55px;
        }

        .respuesta-label {
            font-size: 0.85rem;
            color: #8898aa;
            margin-bottom: 5px;
        }

        .respuesta-texto {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .respuesta-tuya {
            background: #f7f8fa;
            border: 1px solid #e9ecef;
        }

        .respuesta-correcta-texto {
            background: rgba(45, 206, 137, 0.1);
            border: 1px solid rgba(45, 206, 137, 0.3);
            color: #2dce89;
        }

        /* BOTONES DE ACCION */
        .botones-accion {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-azul {
            background: linear-gradient(135deg, #5e72e4, #764ba2);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-azul:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(94, 114, 228, 0.4);
            color: white;
        }

        .btn-verde {
            background: linear-gradient(135deg, #2dce89, #11cdef);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-verde:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(45, 206, 137, 0.4);
            color: white;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .podio {
                flex-direction: column;
                align-items: center;
            }

            .podio-item {
                order: 0;
            }

            .primero {
                order: -1;
            }

            .resultado-titulo {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>

<div id="particles-js"></div>

<div class="resultados-container">
    <!-- TITULO -->
    <h1 class="resultado-titulo" id="resultadoTitulo">Resultados</h1>
    <p class="resultado-subtitulo">Asi quedo el ranking final</p>

    <!-- PODIO -->
    <div class="podio-container">
        <div class="podio">
            <!-- Segundo Lugar -->
            <div class="podio-item segundo" style="display: none;" id="segundo">
                <div class="podio-avatar">
                    <span id="segundo-inicial">B</span>
                </div>
                <div class="podio-nombre" id="segundo-nombre">Jugador 2</div>
                <div class="podio-stats">
                    <div class="podio-puntaje" id="segundo-puntaje">850</div>
                    <div class="podio-correctas" id="segundo-correctas">8/10 correctas</div>
                </div>
                <div class="podio-base">
                    <div style="font-size: 3rem; font-weight: 700; color: #666;">2</div>
                </div>
            </div>

            <!-- Primer Lugar -->
            <div class="podio-item primero" style="display: none;" id="primero">
                <div class="podio-avatar">
                    <span id="primero-inicial">A</span>
                </div>
                <div class="podio-nombre" id="primero-nombre">Jugador 1</div>
                <div class="podio-stats">
                    <div class="podio-puntaje" id="primero-puntaje">1000</div>
                    <div class="podio-correctas" id="primero-correctas">10/10 correctas</div>
                </div>
                <div class="podio-base">
                    <div style="font-size: 3rem; font-weight: 700; color: #B8860B;">1</div>
                </div>
            </div>

            <!-- Tercer Lugar -->
            <div class="podio-item tercero" style="display: none;" id="tercero">
                <div class="podio-avatar">
                    <span id="tercero-inicial">C</span>
                </div>
                <div class="podio-nombre" id="tercero-nombre">Jugador 3</div>
                <div class="podio-stats">
                    <div class="podio-puntaje" id="tercero-puntaje">720</div>
                    <div class="podio-correctas" id="tercero-correctas">7/10 correctas</div>
                </div>
                <div class="podio-base">
                    <div style="font-size: 3rem; font-weight: 700; color: #CD7F32;">3</div>
                </div>
            </div>
        </div>
    </div>

    <!-- RANKING COMPLETO -->
    <div class="ranking-completo">
        <h3><i class="bi bi-list-ol me-2"></i>Ranking Completo</h3>
        <div id="rankingCompleto"></div>
    </div>

    <!-- MIS RESPUESTAS -->
    <div class="mis-respuestas">
        <h3><i class="bi bi-clipboard-check me-2"></i>Mis Respuestas</h3>
        <div id="misRespuestas">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando tus respuestas...</p>
            </div>
        </div>
    </div>

    <!-- BOTONES DE ACCION -->
    <div class="botones-accion">
        <button class="btn btn-azul btn-ripple" onclick="window.location.href='dashboard.html'">
            <i class="bi bi-house-fill me-2"></i>Volver al Dashboard
        </button>
        <button class="btn btn-verde btn-ripple" onclick="compartirResultados()">
            <i class="bi bi-share-fill me-2"></i>Compartir Resultados
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="js/animations.js"></script>
<script src="js/auth.js"></script>

<script>
    let codigoSala = null;
    let usuario = null;
    let rankingFinal = [];
    let miPosicion = 0;
    let totalPreguntas = 0;

    document.addEventListener('DOMContentLoaded', async function() {
        protegerPagina('login.html');
        usuario = obtenerUsuario();

        const params = new URLSearchParams(window.location.search);
        codigoSala = params.get('codigo');

        if (!codigoSala) {
            alert('Codigo de sala no especificado');
            window.location.href = 'dashboard.html';
            return;
        }

        // Inicializar particles
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80 },
                    color: { value: '#ffffff' },
                    opacity: { value: 0.3 },
                    size: { value: 3 },
                    move: { enable: true, speed: 2 }
                }
            });
        }

        // Cargar datos
        await cargarResultados();
    });

    async function cargarResultados() {
        try {
            console.log('Cargando resultados para sala:', codigoSala);

            const response = await fetch(`/SparkyTrivia/api/salas/resultados?codigo=${codigoSala}`, {
                method: 'GET',
                credentials: 'include'
            });

            const data = await response.json();
            console.log('Respuesta del servidor:', data);

            if (!data.success || !data.ranking || data.ranking.length === 0) {
                const rankingGuardado = localStorage.getItem('rankingFinal_' + codigoSala);
                if (rankingGuardado) {
                    rankingFinal = JSON.parse(rankingGuardado);
                    console.log('Ranking cargado desde localStorage');
                } else {
                    throw new Error('No se encontraron resultados');
                }
            } else {
                rankingFinal = data.ranking;
                console.log('Ranking cargado desde servidor');
            }

            // Encontrar mi posicion y calcular total de preguntas
            const miResultado = rankingFinal.find(r => r.nickname === usuario.nickName);
            if (miResultado) {
                miPosicion = miResultado.rangoFinal;
                totalPreguntas = miResultado.respondidas;
                console.log('Mi posicion:', miPosicion, '| Total preguntas:', totalPreguntas);
            }

            // Mostrar resultados
            mostrarPodio();
            mostrarRankingCompleto();
            await cargarMisRespuestas();

            // Efecto de confetti si ganaste
            if (miPosicion === 1 && typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: 0.4 }
                });
                document.getElementById('resultadoTitulo').textContent = 'GANASTE!';
            } else if (miPosicion <= 3 && miPosicion > 0) {
                document.getElementById('resultadoTitulo').textContent = 'Top 3!';
            }

        } catch (error) {
            console.error('Error cargando resultados:', error);
            document.getElementById('rankingCompleto').innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    No se pudieron cargar los resultados: ${error.message}
                </div>
            `;
        }
    }

    /**
     * CORREGIDO: Muestra el podio SIN el texto de precision
     */
    function mostrarPodio() {
        console.log('Mostrando podio');

        if (rankingFinal.length >= 1) {
            const primero = rankingFinal[0];
            const totalPreg = primero.respondidas || totalPreguntas || 10;

            document.getElementById('primero').style.display = 'block';
            document.getElementById('primero-inicial').textContent = primero.nickname.charAt(0).toUpperCase();
            document.getElementById('primero-nombre').textContent = primero.nickname;
            document.getElementById('primero-puntaje').textContent = primero.puntajeFinal || 0;
            document.getElementById('primero-correctas').textContent =
                `${primero.correctas || 0}/${totalPreg} correctas`;
        }

        if (rankingFinal.length >= 2) {
            const segundo = rankingFinal[1];
            const totalPreg = segundo.respondidas || totalPreguntas || 10;

            document.getElementById('segundo').style.display = 'block';
            document.getElementById('segundo-inicial').textContent = segundo.nickname.charAt(0).toUpperCase();
            document.getElementById('segundo-nombre').textContent = segundo.nickname;
            document.getElementById('segundo-puntaje').textContent = segundo.puntajeFinal || 0;
            document.getElementById('segundo-correctas').textContent =
                `${segundo.correctas || 0}/${totalPreg} correctas`;
        }

        if (rankingFinal.length >= 3) {
            const tercero = rankingFinal[2];
            const totalPreg = tercero.respondidas || totalPreguntas || 10;

            document.getElementById('tercero').style.display = 'block';
            document.getElementById('tercero-inicial').textContent = tercero.nickname.charAt(0).toUpperCase();
            document.getElementById('tercero-nombre').textContent = tercero.nickname;
            document.getElementById('tercero-puntaje').textContent = tercero.puntajeFinal || 0;
            document.getElementById('tercero-correctas').textContent =
                `${tercero.correctas || 0}/${totalPreg} correctas`;
        }
    }

    /**
     * CORREGIDO: Muestra el ranking completo SIN el texto de precision
     */
    function mostrarRankingCompleto() {
        console.log('Mostrando ranking completo');
        const container = document.getElementById('rankingCompleto');

        if (!rankingFinal || rankingFinal.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay datos de ranking</p>';
            return;
        }

        container.innerHTML = rankingFinal.map(jugador => {
            const esYo = jugador.nickname === usuario.nickName;

            return `
                <div class="ranking-tabla-item ${esYo ? 'yo' : ''}">
                    <div class="ranking-tabla-pos">${jugador.rangoFinal || '?'}</div>
                    <div class="ranking-tabla-info">
                        <div class="ranking-tabla-nombre">
                            ${jugador.nickname}
                            ${esYo ? '<span class="badge bg-primary ms-2">TU</span>' : ''}
                        </div>
                        <div class="ranking-tabla-stats">
                            <span><i class="bi bi-check-circle-fill text-success me-1"></i>${jugador.correctas || 0}/${jugador.respondidas || 0} correctas</span>
                        </div>
                    </div>
                    <div class="ranking-tabla-pts">${jugador.puntajeFinal || 0}</div>
                </div>
            `;
        }).join('');
    }

    /**
     * CORREGIDO: Carga y muestra las respuestas del jugador
     */
    async function cargarMisRespuestas() {
        console.log('Cargando mis respuestas...');

        try {
            const response = await fetch(`/SparkyTrivia/api/salas/mis-respuestas?codigo=${codigoSala}`, {
                method: 'GET',
                credentials: 'include'
            });

            const data = await response.json();
            console.log('Respuesta del servidor (mis-respuestas):', data);

            if (data.success && data.respuestas && data.respuestas.length > 0) {
                mostrarMisRespuestas(data.respuestas);
                console.log('Respuestas cargadas:', data.respuestas.length);
            } else {
                document.getElementById('misRespuestas').innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No se encontraron tus respuestas registradas.
                        ${data.message ? '<br><small>' + data.message + '</small>' : ''}
                    </div>
                `;
            }

        } catch (error) {
            console.error('Error cargando respuestas:', error);
            document.getElementById('misRespuestas').innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    No se pudieron cargar las respuestas: ${error.message}
                </div>
            `;
        }
    }

    /**
     * CORREGIDO: Muestra las respuestas del jugador con pregunta, respuesta seleccionada y respuesta correcta
     */
    function mostrarMisRespuestas(respuestas) {
        const container = document.getElementById('misRespuestas');

        if (!respuestas || respuestas.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No hay respuestas para mostrar
                </div>
            `;
            return;
        }

        container.innerHTML = respuestas.map((respuesta, index) => {
            const esCorrecta = respuesta.esCorrecta;

            return `
                <div class="respuesta-item ${esCorrecta ? 'correcta' : 'incorrecta'}">
                    <div class="respuesta-header">
                        <div class="respuesta-icono">
                            ${esCorrecta ? '<i class="bi bi-check-lg"></i>' : '<i class="bi bi-x-lg"></i>'}
                        </div>
                        <div class="respuesta-pregunta">
                            Pregunta ${index + 1}: ${respuesta.pregunta}
                        </div>
                        <div class="respuesta-puntos">
                            ${esCorrecta ? '+' : ''}${respuesta.puntosGanados || 0} pts
                        </div>
                    </div>
                    <div class="respuesta-detalles">
                        <div class="respuesta-label">Tu respuesta:</div>
                        <div class="respuesta-texto respuesta-tuya">
                            ${respuesta.tuRespuesta || 'No respondida'}
                        </div>
                        ${!esCorrecta ? `
                            <div class="respuesta-label">Respuesta correcta:</div>
                            <div class="respuesta-texto respuesta-correcta-texto">
                                ${respuesta.respuestaCorrecta}
                            </div>
                        ` : ''}
                        <div class="text-muted" style="font-size: 0.85rem;">
                            <i class="bi bi-clock me-1"></i>Respondiste en ${respuesta.tiempoTomado || 0}s
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function compartirResultados() {
        const miResultado = rankingFinal.find(r => r.nickname === usuario.nickName);
        const correctas = miResultado ? miResultado.correctas : 0;
        const total = miResultado ? miResultado.respondidas : 0;
        const puntaje = miResultado ? miResultado.puntajeFinal : 0;

        const texto = `Termine la trivia en Sparky Trivia!

Posicion: #${miPosicion}
Correctas: ${correctas}/${total}
Puntaje: ${puntaje} pts
Codigo de sala: ${codigoSala}

Unite y competi conmigo!`;

        if (navigator.share) {
            navigator.share({
                title: 'Sparky Trivia - Mis Resultados',
                text: texto
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(texto).then(() => {
                alert('Resultados copiados al portapapeles!');
            }).catch(err => {
                console.error('Error al copiar:', err);
                alert('No se pudo copiar al portapapeles');
            });
        }
    }
</script>
</body>
</html>